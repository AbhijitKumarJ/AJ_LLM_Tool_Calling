<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groq Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background-color: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #3a3a3a;
            color: #ffffff;
            padding: 10px;
            text-align: center;
            font-size: 1.2em;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            max-width: 80%;
        }
        .user-message {
            background-color: #4a4a4a;
            margin-left: auto;
        }
        .bot-message {
            background-color: #3a3a3a;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #3a3a3a;
        }
        .chat-input textarea {
            flex-grow: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background-color: #4a4a4a;
            color: #ffffff;
            resize: vertical;
            min-height: 50px;
            max-height: 150px;
        }
        .chat-input button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            background-color: #5a5a5a;
            color: #ffffff;
            cursor: pointer;
            align-self: flex-end;
        }
        .chat-input button:hover {
            background-color: #6a6a6a;
        }
        .confirmation-box {
            background-color: #3a3a3a;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .confirmation-box button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">Groq Chatbot</div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be dynamically added here -->
        </div>
        <div class="chat-input">
            <textarea id="userInput" placeholder="Type your message..." rows="3"></textarea>
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script>
        var GROQ_API_KEY = "{{ api_key }}";
        // function sendMessage() {
        //     const userInput = document.getElementById('userInput');
        //     const chatMessages = document.getElementById('chatMessages');

        //     if (userInput.value.trim() === '') return;

        //     // Add user message to chat
        //     addMessage(userInput.value, 'user-message');

        //     // Clear input field
        //     userInput.value = '';

        //     // Simulate API call and response handling
        //     simulateGroqResponse(chatMessages);
        // }
        $(document).ready(function() {
            $('#sendButton').click(sendMessage);
            $('#userInput').keydown(function(e) {
                if (e.ctrlKey && e.keyCode == 13) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        function sendMessage() {
            const userInput = $('#userInput');
            const userMessage = userInput.val().trim();

            if (userMessage === '') return;

            addMessage(userMessage, 'user-message');
            userInput.val('');

            callGroqAPI(userMessage);
        }

        function addMessage(content, className) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function simulateGroqResponse(chatMessages) {
            // Simulating different response types
            const responseTypes = ['normal', 'additional-info', 'confirmation'];
            const randomType = responseTypes[Math.floor(Math.random() * responseTypes.length)];

            setTimeout(() => {
                switch(randomType) {
                    case 'normal':
                        addMessage("This is a normal response from the Groq API.", 'bot-message');
                        break;
                    case 'additional-info':
                        addMessage("I need some additional information. What's your preferred programming language?", 'bot-message');
                        break;
                    case 'confirmation':
                        const confirmationBox = document.createElement('div');
                        confirmationBox.className = 'message bot-message confirmation-box';
                        confirmationBox.innerHTML = `
                            Do you want to proceed with this action?
                            <button onclick="handleConfirmation(true)">Yes</button>
                            <button onclick="handleConfirmation(false)">No</button>
                        `;
                        chatMessages.appendChild(confirmationBox);
                        break;
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }

        function handleConfirmation(confirmed) {
            const response = confirmed ? "You confirmed the action." : "You declined the action.";
            addMessage(response, 'bot-message');
        }



        function callGroqAPI(userMessage) {
            $.ajax({
                url: 'https://api.groq.com/openai/v1/chat/completions',
                type: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_API_KEY}`
                },
                data: JSON.stringify({
                    messages: [
                        {
                            role: 'system',
                            content: "You are an expert in understanding user intension and can break it down as one or more tasks with parameters associated with it. Try to respond with the array of task object in json format. Where each task has intent_category, intent_sub_category, intent_label, intent_description, intent_parameters, intent_response, is_tool_usage_required fields. Create one object for each intent and put all intents in an array in json format. Don't generate any extra text other than json. Strict to the format given here."
                        },
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ],
                    model: 'llama-3.1-8b-instant',
                    temperature: 0.5,
                    max_tokens: 1024,
                    top_p: 1,
                    stream: false,
                    response_format: {
                        type: "json_object"
                    },
                    stop: null
                }),
                success: function(response) {
                    handleGroqResponse(response);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error calling Groq API:', textStatus, errorThrown);
                    addMessage(`Error: ${textStatus}`, 'bot-message error-message');
                    if (jqXHR.responseText) {
                        addMessage(`Debug Info: ${jqXHR.responseText}`, 'debug-info');
                    }
                }
            });
        }



        function handleGroqResponse(response) {
            console.log(response)
            if (response.choices && response.choices.length > 0) {
                const content = JSON.parse(response.choices[0].message.content);
                
                // Assuming the JSON response has a 'response' field
                if (content) {
                    addMessage(content, 'bot-message');
                } else {
                    addMessage('Received a response, but it was not in the expected format.', 'bot-message error-message');
                }
            } else {
                addMessage('Received an empty response from the API.', 'bot-message error-message');
            }
        }

    </script>
</body>
</html>